kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  labels:
    name: talky-core-api
  name: talky-core-api
spec:
  replicas: 1
  selector:
    matchLabels:
      name: talky-core-api
  strategy:
    type: Recreate
  template:
    metadata:
      name: talky-core-api
      labels:
        name: talky-core-api
    spec:
      containers:
        - name: kubectl
          image: lachlanevenson/k8s-kubectl:latest
          imagePullPolicy: Always
          args:
          - proxy
          - -p
          - "8001"
        - name: api
          image: andyet/talky-core-api:0.1
          imagePullPolicy: Always
          env:
          - name: KUBERNETES_RO_SERVICE_HOST
            value: 127.0.0.1
          - name: KUBERNETES_RO_SERVICE_PORT
            value: "8001"
          - name: POSTGRES_HOST
            valueFrom:
              configMapKeyRef:
                name: cm-talky-api
                key: postgres-host
          - name: TALKY_LICENSE
            valueFrom:
              configMapKeyRef:
                name: cm-talky-api
                key: license-key
          - name: TURN_SECRET
            valueFrom:
              configMapKeyRef:
                name: cm-talky-api
                key: turn-auth-shared
          lifecycle:
            postStart:
              exec:
                command: ["/usr/local/bin/node", "/app/scripts/create-configmap.js"]
      dnsPolicy: ClusterFirst
      hostNetwork: true
      imagePullSecrets:
      - name: andyetops
      nodeSelector:
        service: talky-core-api
      restartPolicy: Always
      terminationGracePeriodSeconds: 10
